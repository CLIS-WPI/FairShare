# Development Dockerfile - extends NVIDIA TensorFlow base with dev tools
# This should be built after the main image, or use multi-stage build
# For now, we'll use the same base image to ensure it can build independently
FROM nvcr.io/nvidia/tensorflow:24.12-tf2-py3

# Set working directory
WORKDIR /workspace

# Set timezone
ENV TZ=America/New_York
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Install base system dependencies first
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    wget \
    unzip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy and install Python requirements
COPY requirements.txt .
RUN python3 -m pip install --no-cache-dir --upgrade pip && \
    python3 -m pip install --no-cache-dir sionna && \
    python3 -m pip install --no-cache-dir -r requirements.txt

# Set Python path
ENV PYTHONPATH=/workspace

# Install development tools
RUN apt-get update && apt-get install -y \
    vim \
    nano \
    htop \
    git \
    iputils-ping \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# Install Jupyter Lab and development tools
RUN python3 -m pip install --no-cache-dir \
    jupyterlab \
    jupyter \
    ipywidgets \
    matplotlib \
    seaborn \
    ipython \
    notebook \
    && rm -rf /root/.cache/pip

# Configure Jupyter
RUN mkdir -p /root/.jupyter && \
    echo "c.ServerApp.ip = '0.0.0.0'" > /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.port = 8888" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.token = ''" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.password = ''" >> /root/.jupyter/jupyter_lab_config.py

# Create startup script
RUN echo '#!/bin/bash\n\
if [ "$1" = "jupyter" ]; then\n\
    jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token="" --NotebookApp.password=""\n\
elif [ "$1" = "notebook" ]; then\n\
    jupyter notebook --ip=0.0.0.0 --port=8889 --no-browser --allow-root --NotebookApp.token="" --NotebookApp.password=""\n\
else\n\
    exec "$@"\n\
fi' > /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/entrypoint.sh

WORKDIR /workspace

# Default command
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/bin/bash"]

