# Development Dockerfile - extends NVIDIA TensorFlow base with dev tools
# This should be built after the main image, or use multi-stage build
# For now, we'll use the same base image to ensure it can build independently
FROM nvcr.io/nvidia/tensorflow:24.12-tf2-py3

# Set working directory
WORKDIR /workspace

# Set timezone
ENV TZ=America/New_York
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Update CA certificates first (fix certificate expiration issues)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && update-ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install base system dependencies first
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    wget \
    unzip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy and install Python requirements
COPY requirements.txt .

# Verify Python version
RUN python3 --version

# Install core Python dependencies
RUN python3 -m pip install --no-cache-dir --upgrade pip && \
    python3 -m pip install --no-cache-dir -r requirements.txt

# Install TensorFlow 2.19.0 (override base image version)
RUN python3 -m pip install --no-cache-dir tensorflow==2.19.0

# Install Sionna 1.2.1 (matching final Dockerfile)
RUN python3 -m pip install --no-cache-dir sionna==1.2.1

# Verify Sionna
RUN python3 -c "import sionna; print(f'✓ Sionna {sionna.__version__} installed')" || \
    echo "⚠ Sionna import failed"

# Install OpenNTN using official install script
# Note: This requires network access and may fail due to SSL/certificate issues
# If it fails, the code will use fallback models (which is OK)
RUN cd /tmp && \
    export GIT_TERMINAL_PROMPT=0 && \
    export GIT_ASKPASS=echo && \
    git config --global credential.helper store || true && \
    git config --global http.sslVerify false || true && \
    (git clone --depth 1 https://github.com/ant-uni-bremen/OpenNTN.git openntn 2>&1 || \
     echo "⚠ OpenNTN clone failed, will use fallback") && \
    if [ -d "openntn" ]; then \
        cd openntn && \
        bash install.sh 2>&1 || echo "⚠ OpenNTN install.sh failed, will use fallback"; \
    fi

# Verify OpenNTN installation
RUN python3 -c "from sionna.phy.channel import tr38811; print('✓ OpenNTN installed')" 2>&1 || \
    python3 -c "import openntn; print('✓ OpenNTN installed (standalone)')" 2>&1 || \
    echo "⚠ OpenNTN not available, using fallback models (this is OK)"

# Set Python path
ENV PYTHONPATH=/workspace

# Install development tools
RUN apt-get update && apt-get install -y \
    vim \
    nano \
    htop \
    git \
    iputils-ping \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# Install Jupyter Lab and development tools
RUN python3 -m pip install --no-cache-dir \
    jupyterlab \
    jupyter \
    ipywidgets \
    matplotlib \
    seaborn \
    ipython \
    notebook \
    && rm -rf /root/.cache/pip

# Configure Jupyter
RUN mkdir -p /root/.jupyter && \
    echo "c.ServerApp.ip = '0.0.0.0'" > /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.port = 8888" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.token = ''" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.password = ''" >> /root/.jupyter/jupyter_lab_config.py

# Create startup script
RUN echo '#!/bin/bash\n\
if [ "$1" = "jupyter" ]; then\n\
    jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token="" --NotebookApp.password=""\n\
elif [ "$1" = "notebook" ]; then\n\
    jupyter notebook --ip=0.0.0.0 --port=8889 --no-browser --allow-root --NotebookApp.token="" --NotebookApp.password=""\n\
else\n\
    exec "$@"\n\
fi' > /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/entrypoint.sh

WORKDIR /workspace

# Default command
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/bin/bash"]

